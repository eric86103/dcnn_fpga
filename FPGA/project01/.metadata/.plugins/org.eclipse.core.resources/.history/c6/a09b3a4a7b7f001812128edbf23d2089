#include "alt_types.h"
void truncation(alt_16 data) {
   if((alt_8)data > max_num) {
      prinf("    Data %f is bigger than %f!!\n", (double)(data) >>4, (double)(max_num)>>4);
      return max_num;
   }
   else if((alt_8)data < 0) {
      prinf("    Data %f is smaller than %f!!\n", (double)(data) >>4, (double)(0) >>4);
      return 0;
   }
   return (alt_u8)data;
};

void matrix_to_imageCube(alt_16* matrix_result, alt_u8* o_fmap, int height, int width, int depth) {
   printf("  Transforming matrix to image cube...\n");
   int h = 0, w = 0, d = 0;
   for(int d = 0; d < depth; d++) {
      alt_u8* current_map = matrix_result + d;
      for(int w = 0; w < width; w++) {
         for(int h = 0; h < height; h++) {
            printf("    Data before truncate: %f\n", ((double)(*(current_map + (h + w*height)*depth))) >> 4);
            *(o_fmap+h*width*depth+w*depth+d) = truncation(*(current_map + (h + w*height)*depth));
            printf("    Data after truncate: %f\n", (double)(*(o_fmap+ h*width*depth + w*depth + d)) >> 4);
         }
      }
   }
};


void flatten_matrix(alt_u8* flattened_matrix, alt_u8* input_fmap, int filter_h, int filter_w, int filter_d, int input_fmap_w, int input_fmap_h)
{
   printf("  flatten input_fmap to flattened_matrix ...................................................\n");
   int w = 0, h = 0, d = 0;
   int count = 0;
   while(h + filter_h <= input_fmap_h)
   {
      while(w + filter_w <= input_fmap_w)
      {  
         int w_in, h_in, d_in = 0;
         for(h_in = 0; h_in < filter_h; ++h_in){
            for (w_in = 0; w_in < filter_w; ++w_in){
               for (d_in = 0; d_in < filter_d; ++d_in){
                  *(flattened_matrix + count) = *(input_fmap + (h_i * filter_d * filter_w) + (w_in * filter_d) + d_in);
                  count ++;
               }
            }
         }
         w = w + 1;
      }
      h = h + 1;
      w = 0;
   }
};
